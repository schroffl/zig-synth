<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zig Synthesizer in WebAssembly</title>

    <style>
        body {
            font-family: Arial;
            margin: 0px;
            overflow: hidden;
        }

        #play-button {
            font-size: 42px;
            background-color: mediumpurple;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: #000 0px 5px 10px;
            margin-bottom: 20px;
            padding: 8px 16px;
        }

        #play-button:hover, #play-button:focus {
            outline: none;
            background-color: #5b32af;
        }

        #play-button:active {
            margin-top: 2px;
            margin-bottom: 18px;
            box-shadow: #000 0px 2px 6px;
        }

        .note {
            font-family: "Comic Sans MS";
            max-width: 50%;
            text-align: center;
        }

        .hash {
            position: absolute;
            cursor: help;
            top: 8px;
            left: 8px;
            color: rgba(0, 0, 0, 0.3);
        }

        .hash:hover {
            color: black;
        }

        @media (prefers-color-scheme: light) {
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #444;
                color: #eee;
            }

            .hash {
                color: rgba(238, 238, 238, 0.3);
            }

            .hash:hover {
                color: #eee;
            }
        }

        .button-wrapper {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="button-wrapper">
        <button id="play-button">Start</button>
        <div class="note">
            This button is required, because your browser prevents audio from playing automatically.
            Connect a MIDI input device and start playing.

            <hr>

            <small>
                Due to missing API implementations in most browsers, this is currently only known to work in Google Chrome.
                <br>
                Check <a href="https://caniuse.com/#search=Audio%20Worklet">Audio Worklet Support</a> to find out if this has changed.
            </small>
        </div>
        <div class="hash" title="This mainly exists to check weird browser cache behaviour">Build: bb4261a2447939ce</div>
    </div>

    <script>
        window.workletSource = "data:text/javascript;base64,ZnVuY3Rpb24gZ2V0U3RyaW5nKGluc3QsIHB0ciwgbGVuKSB7CiAgICBjb25zdCBzbGljZSA9IGRlcmVmQnVmZmVyKFVpbnQ4QXJyYXksIGluc3QsIHB0ciwgbGVuKTsKICAgIGNvbnN0IGFyciA9IFtdOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2xpY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaGFyID0gU3RyaW5nLmZyb21DaGFyQ29kZShzbGljZVtpXSk7CiAgICAgICAgYXJyLnB1c2goY2hhcik7CiAgICB9CgogICAgcmV0dXJuIGFyci5qb2luKCcnKTsKfQoKZnVuY3Rpb24gZGVyZWZCdWZmZXIoVCwgaW5zdCwgcHRyLCBsZW4pIHsKICAgIHJldHVybiBuZXcgVChpbnN0LmV4cG9ydHMubWVtb3J5LmJ1ZmZlciwgcHRyLCBsZW4pOwp9CgpmdW5jdGlvbiBhbGxvY0J1ZmZlcihULCBpbnN0LCBsZW4pIHsKICAgIGNvbnN0IHB0ciA9IGluc3QuZXhwb3J0cy5qc19hbGxvYyhULkJZVEVTX1BFUl9FTEVNRU5UICogbGVuKTsKCiAgICByZXR1cm4gewogICAgICAgIHB0cjogcHRyLAogICAgICAgIGRhdGE6IGRlcmVmQnVmZmVyKFQsIGluc3QsIHB0ciwgbGVuKSwKICAgIH07Cn0KCmZ1bmN0aW9uIGZyZWVCdWZmZXIoaW5zdCwgYnVmZmVyKSB7CiAgICBpbnN0LmV4cG9ydHMuanNfZnJlZShidWZmZXIucHRyLCBidWZmZXIuZGF0YS5ieXRlTGVuZ3RoKTsKfQoKY2xhc3MgWmlnU3ludGhQcm9jZXNzb3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHN1cGVyKCk7CgogICAgICAgIHRoaXMucG9ydC5vbm1lc3NhZ2UgPSB0aGlzLm9uTWVzc2FnZS5iaW5kKHRoaXMpOwogICAgfQoKICAgIGluaXRXYXNtKGJpbmFyeSwgc2FtcGxlX3JhdGUpIHsKICAgICAgICBsZXQgaW5zdGFuY2VfY2xvc3VyZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUoYmluYXJ5LCB7CiAgICAgICAgICAgIGRlYnVnOiB7CiAgICAgICAgICAgICAgICBqc19lcnI6IChwdHIsIGxlbikgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9IGdldFN0cmluZyhpbnN0YW5jZV9jbG9zdXJlLCBwdHIsIGxlbik7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGpzX3dhcm46IChwdHIsIGxlbikgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9IGdldFN0cmluZyhpbnN0YW5jZV9jbG9zdXJlLCBwdHIsIGxlbik7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cobXNnKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSkudGhlbihpbnN0ID0+IHsKICAgICAgICAgICAgaW5zdGFuY2VfY2xvc3VyZSA9IGluc3QuaW5zdGFuY2U7CiAgICAgICAgICAgIGluc3QuaW5zdGFuY2UuZXhwb3J0cy5pbml0X3N5bnRoKHNhbXBsZV9yYXRlKTsKICAgICAgICAgICAgdGhpcy53YXNtID0gaW5zdC5pbnN0YW5jZTsKICAgICAgICB9KTsKICAgIH0KCiAgICBvbk1lc3NhZ2UoZXZlbnQpIHsKICAgICAgICBzd2l0Y2ggKGV2ZW50LmRhdGEudHlwZSkgewogICAgICAgICAgICBjYXNlICd3YXNtLWJpbmFyeSc6IHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFdhc20oZXZlbnQuZGF0YS5kYXRhLCBldmVudC5kYXRhLnNhbXBsZV9yYXRlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlICdtaWRpLW1lc3NhZ2UnOiB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NNSURJKGV2ZW50LmRhdGEuZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwcm9jZXNzTUlESShkYXRhKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYWxsb2NCdWZmZXIoVWludDhBcnJheSwgdGhpcy53YXNtLCBkYXRhLmJ5dGVMZW5ndGgpOwoKICAgICAgICBidWZmZXIuZGF0YS5zZXQoZGF0YSk7CiAgICAgICAgdGhpcy53YXNtLmV4cG9ydHMucHJvY2Vzc19taWRpKGJ1ZmZlci5wdHIsIGRhdGEuYnl0ZUxlbmd0aCk7CgogICAgICAgIGZyZWVCdWZmZXIodGhpcy53YXNtLCBidWZmZXIpOwogICAgfQoKICAgIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzLCBwYXJhbXMpIHsKICAgICAgICBpZiAoIXRoaXMud2FzbSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGNoYW5uZWwgPSBvdXRwdXRzWzBdWzBdOwoKICAgICAgICAvLyBUT0RPIElkZWFsbHkgd2Ugd2FudCB0byBhbGxvY2F0ZSB0aGlzIGJ1ZmZlciBvbmx5IG9uY2UuCiAgICAgICAgLy8gICAgICBIb3dldmVyLCBJIG5lZWQgdG8gZmlndXJlIGhvdyB0byBwcmV2ZW50IHRoZSBaaWcgYWxsb2NhdG9yCiAgICAgICAgLy8gICAgICBmcm9tIGdyb3dpbmcgdGhlIFdlYkFzc2VtYmx5Lk1lbW9yeS4gV2hlbiB0aGF0IGhhcHBlbnMKICAgICAgICAvLyAgICAgIHRoZSB1bmRlcmx5aW5nIEFycmF5QnVmZmVyIGdldHMgZGV0YWNoZWQgYW5kIHRoZSB3b3JrbWVtIGlzCiAgICAgICAgLy8gICAgICBpbnZhbGlkYXRlZC4gTWF5YmUgd2UgbmVlZCB0byBkZXRlY3QgdGhpcyBhbmQgcmVhbGxvY2F0ZT8KICAgICAgICAvLyAgICAgIEFsdGhvdWdoIEkgdGhpbmsgaXQgbWFrZXMgbW9yZSBzZW5zZSB0byBhbGxvY2F0ZSBhIHNpbmdsZSBzbGljZQogICAgICAgIC8vICAgICAgYXQgc3RhcnR1cCBhbmQgdXNlIHN0ZC5oZWFwLkZpeGVkQnVmZmVyQWxsb2NhdG9yLgogICAgICAgIC8vCiAgICAgICAgLy8gICAgICBTYWRseSwgd2UgY2Fubm90IG1ha2UgdXNlIG9mIHRoZSBQZXJmb3JtYW5jZSBBUEkgaW4gYW4KICAgICAgICAvLyAgICAgIEF1ZGlvIFdvcmtsZXQuIFNvIEknbSB1bmFibGUgdG8gbWVhc3VyZSB0aGUgcGVyZm9ybWFuY2UgaW1wYWN0IHRoYXQgd2F5LgogICAgICAgIC8vICAgICAgU28gZmFyLCB0aG91Z2gsIGl0IHNlZW1zIGxpa2UgdGhlIGRldiB0b29scyBpbiBjaHJvbWUgaGFuZGxlCiAgICAgICAgLy8gICAgICBXZWJBc3NlbWJseSBwcm9maWxpbmcgYXMgd2VsbCBhcyBKYXZhU2NyaXB0LiBUaGUgYWNjdXJhY3kKICAgICAgICAvLyAgICAgIHNob3VsZCBiZSBiZXR0ZXIgdGhhbiB0aGF0IG9mIHRoZSBQZXJmb3JtYW5jZSBBUEksIHRvby4KICAgICAgICBjb25zdCBidWZmZXIgPSBhbGxvY0J1ZmZlcihGbG9hdDMyQXJyYXksIHRoaXMud2FzbSwgY2hhbm5lbC5sZW5ndGgpOwoKICAgICAgICB0aGlzLndhc20uZXhwb3J0cy5nZW5lcmF0ZShidWZmZXIucHRyLCBidWZmZXIuZGF0YS5sZW5ndGgpOwogICAgICAgIGNoYW5uZWwuc2V0KGJ1ZmZlci5kYXRhKTsKCiAgICAgICAgZnJlZUJ1ZmZlcih0aGlzLndhc20sIGJ1ZmZlcik7CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKfQoKcmVnaXN0ZXJQcm9jZXNzb3IoJ3ppZy1zeW50aCcsIFppZ1N5bnRoUHJvY2Vzc29yKTsK";
        window.wasmSource = "data:application/octet-stream;base64,AGFzbQEAAAABOwpgBn9/f39/fwBgAn9/AX9gAX8Bf2ACf38AYAF9AGABfAF8YAJ8fAF8YAJ/fwF9YAJ/fABgA39/fwF/AxIRAAEAAgMEBQYDBwMBBQUICQkEBQFwAQMDBQMBAAIGCAF/AUHgigQLB0YGBm1lbW9yeQIACGpzX2FsbG9jAAMHanNfZnJlZQAECmluaXRfc3ludGgABQhnZW5lcmF0ZQAIDHByb2Nlc3NfbWlkaQAKCQgBAEEBCwIAAgrWUhH9AgEDfyOAgICAAEEQayIGJICAgIAAAkACQAJAAkAgBUH/////AXFBgYAETw0AIARB//8DakEQdiIHIAIoAgQiCEH//wNqQRB2Rg0BIAggBEsNAgJAQYCIgIAAIAcQgYCAgAAiBUF/Rw0AAkBBwIqAgAAgBxCBgICAACIFQX9GDQAgBUGAEGohBQwBCyAHQAAiBUEATA0ECyAFQRB0IQgCQCACKAIEIgdFDQBBACEFA0AgCCAFaiACKAIAIAVqLQAAOgAAIAcgBUEBaiIFRw0ACwsgBkEIaiABIAIgA0EAQQAQgoCAgAAgACAENgIEIAAgCDYCACAAQQA7AQggBkEQaiSAgICAAA8LIABBATsBCCAGQRBqJICAgIAADwsgAEEAOwEIIAIoAgAhBSAAIAQ2AgQgACAFNgIAIAZBEGokgICAgAAPCyAAQQA7AQggACABIAIgAyAEIAUQgoCAgAAgBkEQaiSAgICAAA8LIABBATsBCCAGQRBqJICAgIAAC8YCAwZ/AX4Ef0F/IQICQCAAQQRqKAIAIgNFDQAgA0EHdCEEIAAoAgAhBUEAIQYCQANAAkACQCAFIAZBBHRqIgdBCGopAwAiCEIAUw0AIAcpAwB7IAh7fKcgAUkNAQsgBkEHdCIJQYB/Rg0AIAlBgAFqIQoDQEEAIQsCQANAIAkgC2oiByAETw0BQf8BIAdBB3EiDEEHc3ZBASAMdHEgBSAHQQN2ai0AAHFFDQEgC0EBaiILIAFJDQALIAFFDQQgAUF/aiEBQQAhByAAQQRqIQVBASEMA0BBACELAkAgDEUNACAAKAIAIQsLIAsgCSAHaiIMQQN2aiILIAstAABBfiAMQQdxd3E6AAAgASAHRg0FIAdBAWohByAFKAIAIQwMAAsLIAdBAWoiCSAKSQ0ACwsgBkEBaiIGIANHDQAMAgsLIAkhAgsgAguCAwEHfwJAIAIoAgQgAigCACIGaiIHQf//A2pBEHYiCCAGIARqIglB//8DakEQdiIKTQ0AAkAgCUGAgPw/Sw0AIAhBgBAgCEGAEEkbIgsgCmtFDQAgCiEGA0AgBkEDdkHAiICAAGoiDEEBIAZBB3F0IAwtAAByOgAAIAsgBkEBaiIGRw0ACwsgB0GBgIDAAEkNAAJAQQAoAsSKgIAAIgwNAEGAICEMQQBBgCA2AsSKgIAAQQAgCEF/aiIIQRB0IgY2AsCKgIAAIAZBAEGAgAQQj4CAgAAaCyAIQYAQIAogCUGBgPw/SRsiBmsiC0UNAEEAKALAioCAAEEAIAwbIAZBgHBqIgxBA3ZqIglBASAMQQdxdCAJLQAAcjoAACALQQFGDQAgCEF/aiEIA0BBACgCwIqAgABBAEEAKALEioCAABsgBkGBcGoiDEEDdmoiC0EBIAxBB3F0IAstAAByOgAAIAggBkEBaiIGRw0ACwsgAigCACEGIAAgBDYCBCAAIAY2AgALdQECfyOAgICAAEEQayIBJICAgIAAAkACQCAADQBBACECDAELIAFBoIiAgABBiIiAgAAgASAAQQFBACgCoIiAgAARgICAgAAAAkAgAS8BCEUNAAwBCyABKAIAIgIgASAAEI+AgIAAGgsgAUEQaiSAgICAACACC2cBAX8jgICAgABBEGsiAiSAgICAAAJAIAFFDQAgACACIAEQj4CAgAAhACACIAE2AgwgAiAANgIIIAJBoIiAgAAgAkEIakEBQQBBAUEAKAKkiICAABGAgICAAAALIAJBEGokgICAgAALpQ4JA38CfAF/A3wEfQF/AX4CfQF/I4CAgIAAQZCAAWsiASSAgICAAAJAAkACQEEALQDQioCAAA0AIAFBEGpBoIiAgABBiIiAgAAgAkGAgANBBEEAKAKgiICAABGAgICAAAAgAS8BGA0BIAEoAhAhA0QAAAAAAAAAACEEQQAhAgNAIAFBEGogAmogBEQAAAAAAAAwP6JEGC1EVPshCUCiIgUgBaAQhoCAgAC2OAIAIAREAAAAAAAA8D+gIQQgAkEEaiICQYCAAUcNAAsgAyABQRBqQYCAARCQgICAACEGQQAhA0QAAAAAAAAAACEHA0AgB0QAAAAAAAAwP6JEGC1EVPshCUCiIgQgBKAhCEEoIQJEAAAAAAAAAAAhBUQAAAAAAADwPyEEA0AgBUQAAAAAAADwvyAERAAAAAAAAPC/oBCHgICAACAIIASiEIaAgIAAoiAEo6AhBSAERAAAAAAAAPA/oCEEIAJBf2oiAg0ACyABQRBqIANBAnRqIAVEg8jJbTBf5D+itjgCACAHRAAAAAAAAPA/oCEHIANBAWoiA0GAIEcNAAsgBkGAgAFqIAFBEGpBgIABEJCAgIAAGkEAIQNEAAAAAAAAAAAhCQNAIAlEAAAAAAAAMD+iRBgtRFT7IQlAoiIEIASgIQdBKCECRAAAAAAAAAAAIQVEAAAAAAAAAAAhBANAIAUgByAEIASgRAAAAAAAAPA/oCIIohCGgICAAEQAAAAAAADwPyAIo6KgIQUgBEQAAAAAAADwP6AhBCACQX9qIgINAAsgAUEQaiADQQJ0aiAFtjgCACAJRAAAAAAAAPA/oCEJIANBAWoiA0GAIEcNAAsgBkGAgAJqIAFBEGpBgIABEJCAgIAAGkEAQQE6ANCKgIAAQQBBAzYCzIqAgABBACAGNgLIioCAAAsgAUEQakGgiICAAEGIiICAACACQcASQQhBACgCoIiAgAARgICAgAAAAkAgAS8BGEUNAAwCC0MAAAAAIACVIQogALsiBERmZmZmZmbmP6K2IQsgBES4HoXrUbieP6K2IQwgBESamZmZmZm5P6K2IQ0gASgCECEOQQAhAwNAIA4gA2oiAkEAOgAAIAJB8ABqQgA3AwAgAkHsAGpBADoAACACQegAaiALOAIAIAJB5ABqIAw4AgAgAkHgAGogDTgCACACQdgAakEBOgAAIAJB0ABqQubMmbPmzJnzPzcDACACQcgAakK4vZTcnoquzz83AwAgAkHAAGpCmrPmzJmz5tw/NwMAIAJBNGpCgYCAgNCZs+Y+NwIAIAJBMGogADgCACACQShqQubMmbPmzJnzPzcDACACQSBqQri9lNyeiq7PPzcDACACQRhqQpqz5syZs+bcPzcDACACQQxqQoGAgIDQmbPmPjcCACACQQhqIAA4AgBBACkDyIqAgAAhDyACQbEBaiABLwANOwAAIAJBsAFqQQE6AAAgAkGsAWpBADYCACACQaQBakIANwIAIAJBoAFqQQE2AgAgAkGcAWogADgCACACQZQBaiAPNwIAIAJBkAFqQQA2AgAgAkGIAWpCADcCACACQYQBakEBNgIAIAJBgAFqIAA4AgAgAkH4AGogDzcCACACQbMBaiABQQ1qQQJqLQAAOgAAIAJBvAFqIAo4AgAgAkG4AWpBADYCACACQbQBakGgiICAADYCACACQcgBaiAPQiCIp0F/arNDAAAAAJQiEI0iESAQkzgCACACQcQBaiEGAkACQCARQwAAgE9dIBFDAAAAAGBxRQ0AIBGpIRIMAQtBACESCyAGIBI2AgAgAkHAAWohBgJAAkAgEI4iEUMAAIBPXSARQwAAAABgcUUNACARqSESDAELQQAhEgsgBiASNgIAIAJB6AFqQQApA8iKgIAAIg83AgAgAkHMAWogDzcCACACQYQCakEBOgAAIAJB5AFqQQA2AgAgAkGAAmpBADYCACACQfgBakIANwIAIAJB3AFqQgA3AgAgAkH0AWpBATYCACACQfABaiAAOAIAIAJB2AFqQQE2AgAgAkHUAWogADgCACACQYUCaiABLwAKOwAAIAJBhwJqIAFBCmpBAmotAAA6AAAgAkGgAmpCgICA+IOAgMA/NwIAIAJBkAJqIAo4AgAgAkGMAmpBADYCACACQYgCakGgiICAADYCACACQZwCaiAPQiCIp0F/arNDAAAAAJQiEI0iESAQkzgCACACQZgCaiEGAkACQCARQwAAgE9dIBFDAAAAAGBxRQ0AIBGpIRIMAQtBACESCyAGIBI2AgAgAkGUAmohAgJAAkAgEI4iEUMAAIBPXSARQwAAAABgcUUNACARqSEGDAELQQAhBgsgAiAGNgIAIANBqAJqIgNBwBJHDQAMAgsLC0EAQQg2AriIgIAAQQAgDjYCtIiAgABBAEGgiICAADYCsIiAgAAgAUGQgAFqJICAgIAAC5sFCAF8AX4BfAF+AX8BfAF/BHwjgICAgABBEGsaAkAgAEQAAAAAAAAAAGEgACAAYnJFDQAgAA8LRAEAAAAAAPB/IQECQCAAvUL///////////8AgyICQoCAgICAgID4/wBRDQACQCACvyIDRILIyW0wX/Q/oiIBRAAAAAAAAAAAYQ0AIAG9IgJCNIhC/w+DIgRCsghWDQAgAkIAUyEFAkAgBEL+B1YNAEQAAAAAAADwv0QAAAAAAAAAACAFGyEBDAELIAEgAUQAAAAAAAAww6BEAAAAAAAAMEOgIAFEAAAAAAAAMEOgRAAAAAAAADDDoCAFGyABoSIGoCEBIAZEAAAAAAAAAABkQQFzDQAgAUQAAAAAAADwv6AhAQsCQAJAIAGZRAAAAAAAAOBDY0UNACABsCECDAELQoCAgICAgICAgH8hAgsgAyABIAFEAAAAAAAA8D+gIAJCAYMiBFAbIgFEAAAAQPsh6b+ioCABRAAAAAAtRGS+oqAgAURwUcyYmEbovKKgIgMgA6IhASAARAAAAAAAAAAAYyAEIAJ8QgeDIgJCA1YiBXMhBwJAAkAgAkJ8fCACIAUbQn98QgFWDQAgAUSbGoagSfqovaJEBT9Oe53uIT6gIQAgAUQAAAAAAADgv6JEAAAAAAAA8D+gIQZES1VVVVVVpT8hCESRT8EWbMFWvyEJRPVEyBmgAfo+IQpExkusfk9+kr4hCyABIQMMAQsgAUTNnNEf/djlPaJEXR8pqeXlWr6gIQBESFVVVVVVxb8hCETQ9xARERGBPyEJRAPfvxmgASq/IQpEoUh9VuMdxz4hCyADIQYLIAYgAyABoiABIAEgASABIACiIAugoiAKoKIgCaCiIAigoqAiAJogACAHGyEBCyABC4ANBgF/AXwDfgJ/AnwCfyOAgICAAEEQayICJICAgIAARAAAAAAAAPA/IQMCQAJAAkACQAJAIABEAAAAAAAA8D9hDQAgAUQAAAAAAAAAAGENAEQBAAAAAADwfyEDIAAgAGIgASABYnINAAJAIAFEAAAAAAAA8D9iDQAgACEDDAELAkACQCAARAAAAAAAAAAAYg0AQoGAgICAgID4/wAhBAJAAkAgAb0iBUL///////////8Ag0KAgICAgICA+P8AUg0AIAUhBgwBCyAFQoCAgICAgICAgH+DIQQgBUI0iKdB/w9xIgdBgXhqIQgCQCAHQbMISQ0AIAUgBCAIQYAIRhsgBCAFQv////////8Hg0IAUhshBCAFIQYMAQsCQCAHQf8HTw0AIAQhBiAFIQQMAQsCQCAFIAhBP3GtIgaGQv////////8Hg1BFDQAgBSEGDAELIAFCgICAgICAgHggBocgBYMiBr+hvSEECyAEv0QAAAAAAAAAAGEhBwJAAkAgBr8iA5lEAAAAAAAA4ENjRQ0AIAOwIQUMAQtCgICAgICAgICAfyEFCyAFpyAHcSEHIAFEAAAAAAAAAABjQQFzDQFEAAAAAAAA8H8hAyAHRQ0CIAJBEGokgICAgAAgAL1CgICAgICAgICAf4NCgICAgICAgPj/AIS/DwsCQCABvSIFQv///////////wCDIgRCgICAgICAgPj/AFINAEQAAAAAAADwPyEDIABEAAAAAAAA8L9hDQIgAkEQaiSAgICAAEQAAAAAAADwf0QAAAAAAAAAACAAvUL///////////8Ag79EAAAAAAAA8D9jIAVCgICAgICAgPj/AFFzGw8LAkAgAL0iBkL///////////8Ag0KAgICAgICA+P8AUg0AIAZCgICAgICAgHhRDQNEAAAAAAAAAAAhAyABRAAAAAAAAAAAYw0CRAAAAAAAAPB/IQMgAUQAAAAAAAAAAGQNAgsgAUQAAAAAAADgP2ENAyABRAAAAAAAAOC/YQ0EIARCNIinIgdBgXhqIQgCQAJAAkAgB0GzCEkNACAEQgAgCEGACEYbQgAgBUL/////////B4NCAFIbIQUgBCEGDAELQgAhBgJAIAdB/wdPDQAgBCEFDAELIAS/IQkCQCAEIAhBP3GtIgWGQv////////8Hg1BFDQBEAAAAAAAAAAAhCkEAIQcMAgsgCUKAgICAgICAeCAFhyAEgyIGv6G9IQULIAW/IQoCQCAARAAAAAAAAAAAY0EBcw0ARAEAAAAAAPB/IQMgCkQAAAAAAAAAAGINAwsgCkQAAAAAAAAAAGIhByAGvyEJCyAJRAAAAAAAAOBDZkEBc0UNBUQAAAAAAADwPyEDAkAgB0UNACAJRAAAAAAAAPA/oCAJIApEAAAAAAAA4D9kIgcbIQkgCkQAAAAAAADwv6AgCiAHGyAAEIyAgIAAohCNgICAACEDCyACIAAQjoCAgAACQAJAIAmZRAAAAAAAAOBDY0UNACAJsCEFDAELQoCAgICAgICAgH8hBQsCQAJAIAVQRQ0AQQAhCAwBCyACKAIIIQcgAisDACEAQQAhCANAAkAgB0GAIGpBgcAASQ0AIAcgCGohCAwCCyADIAAgA6IgBUIBg1AiCxshAyAAIACiIgAgAKAgACAARAAAAAAAAOA/YyIMGyEAQQAgByALGyAIaiEIIAdBAXQgDGshByAFQgGHIgVCAFINAAsLAkAgAUQAAAAAAAAAAGNBAXMNAEEAIAhrIQhEAAAAAAAA8D8gA6MhAwsCQAJAIAhBgAhIDQAgA0QAAAAAAADgf6IhAwJAIAhB/w9ODQAgCEGBeGohCAwCCyADRAAAAAAAAOB/oiEDIAhB/RcgCEH9F0gbQYJwaiEIDAELIAhBgXhKDQAgA0QAAAAAAABgA6IhAwJAIAhBuHBMDQAgCEHJB2ohCAwBCyADRAAAAAAAAGADoiEDIAhB8GggCEHwaEobQZIPaiEICyACQRBqJICAgIAAIAMgCEH/B2qtQjSGv6IPCyAARAAAAAAAAAAAIAcbIQMLIAJBEGokgICAgAAgAw8LRAAAAAAAAPA/IACjIAGaEIeAgIAAIQAgAkEQaiSAgICAACAADwsgAkEQaiSAgICAACAAnw8LIAJBEGokgICAgABEAAAAAAAA8D8gAJ+jDwsgABCMgICAACABohCNgICAACEAIAJBEGokgICAgAAgAAvZBwoBfwF9F38BfQJ/An0BfwF9AX8EfQJAQQAoAriIgIAAIgJFDQBDAACAPyACs5UhA0EAIQQDQAJAIAFFDQBBACgCtIiAgAAgBEGoAmxqIgVB7ABqIQYgBUGkAmohByAFQZACaiEIIAVBnAJqIQkgBUGYAmohCiAFQYwCaiELIAVBlAJqIQwgBUHoAWohDSAFQcwBaiEOIAVBhAJqIQ8gBUGgAmohECAFQbwBaiERIAVByAFqIRIgBUHEAWohEyAFQbgBaiEUIAVBwAFqIRUgBUGUAWohFiAFQfgAaiEXIAVBsAFqIRggBUEIaiEZQQAhGgNAQwAAAAAhGwJAIAUtAABBAkkNACAWIBcgGC0AABsoAgAiHCAVKAIAQQ50aiEdAkACQCAUKgIAIh6PIh9DAACAT10gH0MAAAAAYHFFDQAgH6khIAwBC0EAISALIB0gIEECdCIgaioCACEhAkACQCAejSIbQwAAgE9dIBtDAAAAAGBxRQ0AIBupISIMAQtBACEiCyAdICJB/x9xQQJ0IiJqKgIAISMgHCATKAIAQQ50aiIdICBqKgIAISQgHSAiaioCACElIBQgHiARKgIAkiIbOAIAICQgHiAfkyIeICUgJJOUkiEfQwAAgD8gEioCACIkkyElICEgHiAjICGTlJIhHgJAIBtDAACARWBBAXMNAANAIBtDAACAxZIiG0MAAIBFYA0ACyAUIBs4AgALICUgH5QhGyAeICSUISEgDSAOIA8tAAAbKAIAIhwgDCgCAEEOdGohHQJAAkAgCyoCACIejyIfQwAAgE9dIB9DAAAAAGBxRQ0AIB+pISAMAQtBACEgCyAhIBuSISMgHSAgQQJ0IiBqKgIAISECQAJAIB6NIhtDAACAT10gG0MAAAAAYHFFDQAgG6khIgwBC0EAISILIB0gIkH/H3FBAnQiImoqAgAhJSAcIAooAgBBDnRqIh0gIGoqAgAhJCAdICJqKgIAISYgCyAeIAgqAgCSIhs4AgAgISAeIB+TIh4gJSAhk5SSIAkqAgAiH5RDAACAPyAfkyAkIB4gJiAkk5SSlJIhHiAjQwAAgD8gECoCAJOUIR8CQCAbQwAAgEVgQQFzDQADQCAbQwAAgMWSIhtDAACARWANAAsgCyAbOAIACyAQKgIAIRsgGUEBEImAgIAAISEgByoCACAhIB8gHiAblJKUlCEbIAYtAAANACAFQQA6AAALIAMgG5QhGyAAIBpBAnRqIR0CQCAERQ0AIBsgHSoCAJIhGwsgHSAbOAIAIBpBAWoiGiABRw0ACwsgBEEBaiIEIAJHDQALCwvQAgIBfwR9AkAgAC0AZEF/aiICQQNNDQBDAAAAAA8LAkACQAJAAkAgAg4EAwIBAAMLIAAgACoCaCIDIAGzkiIEOAJoAkAgBCAAKgJgIgVeQQFzRQ0AIAAqAmwiBCAEIAMgBZWUkw8LIABCADcDaCAAQQA6AGRDAAAAAA8LIABBMEEIIAAtAFAbaioCAA8LIAAgACoCaCIFIAGzkiIDOAJoIABBMGogAEEIaiAALQBQGygCACICviEEAkAgAyAAKgJcIgZeQQFzRQ0AIABDAACAP0MAAIA/IASTIAUgBpWUkyIEOAJsIAQPCyAAIAI2AmwgAEEANgJoIABBAzoAZCAEDwsgACAAKgJoIgMgAbOSIgQ4AmgCQCAEIAAqAlgiBV5BAXNFDQAgACADIAWVIgQ4AmwgBA8LIABCgICAgICAgMA/NwNoIABBAjoAZEMAAIA/C/MFBQN/An0BfwF9AX8jgICAgABBEGsiAiSAgICAACAALQAAIgNBGHRBGHUhBAJAAkACQAJAAkACQAJAAkACQCADQQR2QQdxDggHBgABAgMEBQcLIAIgAC0AAUH/AHE6AAQgAiAALQACQf8AcToAAwwHCyACIARBD3E6AAQgAiAALQABQf8AcToAAyACIAAtAAJB/wBxOgACDAYLIAIgAC0AAUH/AHE6AAQMBQsgAiAALQABQf8AcToABAwECyACIARBD3E6AAQgAiAALQACQQd0IAAtAAFB/wBxcjoAAgwDCyAEQXhGDQIgAiABOgAEIAIgAUEIdjoAAyACIAFBEHY6AAIMAgsgAiAEQQ9xIgM6AAQgAiAALQABQf8AcSIEOgADIAIgAC0AAkH/AHEiADoAAiACIAM6AAggAiAEOgAJIAIgADoACkEAIQQCQAJAQQAoAriIgIAAIgFFDQBBACgCtIiAgAAiBCEAIAEhAwNAIAAtAABBf2pB/wFxQQJPDQIgAEGoAmohACADQX9qIgMNAAsgBEGkAmoqAgAhBSAEQQhqQQAQiYCAgAAhBiABQQFGDQAgAUF/aiEBIAUgBpQhBUHMBCEAQQEhBwNAQQAoArSIgIAAIABqIgNB3H1qIAQgAyoCACADQeR9akEAEImAgIAAlCIIIAUgBiAHQQFxGyIGXSIHGyEEIABBqAJqIQAgCCEFIAFBf2oiAQ0ACwsgBEEAOgAAIAQgAkEIahCLgICAABoMAgsgACACQQhqEIuAgIAAGgwBCyACIARBD3E6AAQgAiAALQABQf8AcSIHOgADIAIgAC0AAkH/AHE6AAJBACgCuIiAgAAiAUUNAEHwACEAQQAhAwNAAkBBACgCtIiAgAAgAGoiBEGQf2otAABBAkkNACAEQZF/ai0AACAHRw0AIARBfGoiCS0AAEEDcUUNACAJQQQ6AAAgBEEANgIACyAAQagCaiEAIAEgA0EBaiIDRw0ACwsgAkEQaiSAgICAAAuaDAUBfwF8BH0EfwF9IAAgAC0AACICQQEgAhs6AAACQCACDQAgACABLQABQf8AcToAAUQAAAAAAAAAQCABLQABs0MAAIrCkkMAAEBBlbsQh4CAgAAhAwJAAkACQAJAIAEtAAKzQwAAgD+SIgS8IgJBgICABEkNACACQX9KDQELQwEAwH9DAACA/yACQf////8HcSIBGyEFIAJBAEgNAiABRQ0CIARDAAAATJS8IQJB6H4hAQwBCyAEIQUgAkH////7B0sNAUGBfyEBQwAAAAAhBSACQYCAgPwDRg0BCyACQY32qwJqIgJBF3YgAWqyIgZDgCCaPpQgAkH///8DcUHzidT5A2q+QwAAgL+SIgUgBSAFQwAAAD+UlCIEk7xBgGBxviIHQwBg3j6UIAUgB5MgBJMgBSAFQwAAAECSlSIFIAQgBSAFlCIFIAUgBZQiBUPu6ZE+lEOqqio/kpQgBSAFQyaeeD6UQxPOzD6SlJKSlJIiBUMAYN4+lCAGQ9snVDWUIAUgB5JD2eoEuJSSkpKSIQULIANEAAAAAACAe0CiIQMgACAFQ4fcBkCVOAKkAgJAAkAgAEGwAWotAAANACAAQZABaiECIABBjAFqIQEgAEGEAWohCCAAQYABaiEJIABB/ABqIQogAEH4AGohCwwBCyAAQawBaiECIABBqAFqIQEgAEGgAWohCCAAQZwBaiEJIABBmAFqIQogAEGUAWohCwsgA7YhBSABKgIAIQYgAioCACIHIAooAgAiAkF/arOUIQQgCCgCACEBIAkqAgAhDCALKAIAIQgCQAJAIAAtALABDQAgAEGsAWogBzgCACAAQagBaiAGOAIAIABBpAFqIAU4AgAgAEGgAWogATYCACAAQZwBaiAMOAIAIABBmAFqIAI2AgAgAEGUAWogCDYCAEEBIQIMAQsgAEGQAWogBzgCACAAQYwBaiAGOAIAIABBiAFqIAU4AgAgAEGEAWogATYCACAAQYABaiAMOAIAIABB/ABqIAI2AgAgAEH4AGogCDYCAEEAIQILIAAgAjoAsAEgAEG4AWpBADYCACAAQcgBaiAEjSIHIASTOAIAIABBxAFqIQICQAJAIAdDAACAT10gB0MAAAAAYHFFDQAgB6khAQwBC0EAIQELIAYgBZIhByACIAE2AgAgAEHAAWohAgJAAkAgBI4iBEMAAIBPXSAEQwAAAABgcUUNACAEqSEBDAELQQAhAQsgAiABNgIAIABBvAFqIAdDAACARZQgDJU4AgACQAJAIABBhAJqLQAADQAgAEHkAWohAiAAQeABaiEBIABB2AFqIQggAEHUAWohCSAAQdABaiEKIABBzAFqIQsMAQsgAEGAAmohAiAAQfwBaiEBIABB9AFqIQggAEHwAWohCSAAQewBaiEKIABB6AFqIQsLIAEqAgAhBiACKgIAIgcgCigCACICQX9qs5QhBCAIKAIAIQEgCSoCACEMIAsoAgAhCAJAAkAgAC0AhAINACAAQfwBaiAGOAIAIABB+AFqIAU4AgAgAEH0AWogATYCACAAQfABaiAMOAIAIABB7AFqIAI2AgAgAEHoAWogCDYCACAAQYACaiECQQEhAQwBCyAAQeABaiAGOAIAIABB3AFqIAU4AgAgAEHYAWogATYCACAAQdQBaiAMOAIAIABB0AFqIAI2AgAgAEHMAWogCDYCACAAQeQBaiECQQAhAQsgACABOgCEAiACIAc4AgAgAEGMAmpBADYCACAAQZwCaiAEjSIHIASTOAIAIABBmAJqIQICQAJAIAdDAACAT10gB0MAAAAAYHFFDQAgB6khAQwBC0EAIQELIAYgBZIhByACIAE2AgAgAEGUAmohAgJAAkAgBI4iBUMAAIBPXSAFQwAAAABgcUUNACAFqSEBDAELQQAhAQsgAiABNgIAIABBkAJqIAdDAACARZQgDJU4AgACQAJAAkAgAEHsAGotAAAOBQACAgIBAAsgAEEBOgBsIABB8ABqQQA2AgAMAQsgAEEIakEAEImAgIAAIQUgAEEBOgBsIABB8ABqIAUgAEHgAGoqAgCUOAIACyAAQQI6AABBAQ8LQQALhQMDAX4DfwJ8IAC9IgFCIIinIQICQAJAAkACQCABQgBTIgMNACACQf//P0sNAQtEAAAAAAAA8P9EAQAAAAAA8H8gAUL///////////8Ag1AiBBshACADDQIgBA0CIAFC/////w+DIQFBSiEDDAELIAJB//+//wdLDQFBACEDIAFC/////w+DIgFCAFINAEQAAAAAAAAAACEAIAJBgIDA/wNGDQELIAJB4r4laiICQRR2IANqQYF4arciBUQAAOD+Qi7mP6IgASACQf//P3FBnsGa/wNqrUIghoS/RAAAAAAAAPC/oCIAIAVEdjx5Ne856j2iIAAgAEQAAAAAAAAAQKCjIgUgACAARAAAAAAAAOA/oqIiBiAFIAWiIgUgBaIiACAAIABEn8Z40Amawz+iRK94jh3Fccw/oKJEBPqXmZmZ2T+goiAFIAAgACAARERSPt8S8cI/okTeA8uWZEbHP6CiRFmTIpQkSdI/oKJEk1VVVVVV5T+goqCgoqAgBqGgoCEACyAAC/kEAwF+AX8DfAJAIAAgAGENACAADwsgAL0iAUI/iKchAgJAAkACQAJAAkACQAJAAkAgAUIgiEL/////B4MiAUKrxpiEBFQNAAJAIAFCgIDA/wdYDQAgAA8LRAAAAAAAAPB/IQMgAETvOfr+Qi6GQGQNByAARNK8et0rI4bAY0EBcw0BRAAAAAAAAAAAIQMgAERRMC3VEEmHwGNFDQEMBwsgAUKZ5MX1A1QNAiABQrPFwv8DVA0BCyAARP6CK2VHFfc/oiACQQN0QZCIgIAAaisDAKAiA5lEAAAAAAAA4EFjRQ0CIAOqIQIMAwsgAkEBcyACayECDAILAkAgAUKAgMDxA1gNAEEAIQJEAAAAAAAAAAAhBCAAIQUMAwsgAEQAAAAAAADwP6APC0GAgICAeCECCyAAIAK3IgNEAADg/kIu5r+ioCIAIANEdjx5Ne856j2iIgShIQULIAAgBSAFIAUgBaIiAyADIAMgAyADRNCkvnJpN2Y+okTxa9LFQb27vqCiRCzeJa9qVhE/oKJEk72+FmzBZr+gokQ+VVVVVVXFP6CioSIDokQAAAAAAAAAQCADoaMgBKGgRAAAAAAAAPA/oCEDIAJFDQACQAJAIAJBgAhIDQAgA0QAAAAAAADgf6IhAwJAIAJB/w9ODQAgAkGBeGohAgwCCyADRAAAAAAAAOB/oiEDIAJB/RcgAkH9F0gbQYJwaiECDAELIAJBgXhKDQAgA0QAAAAAAABgA6IhAwJAIAJBuHBMDQAgAkHJB2ohAgwBCyADRAAAAAAAAGADoiEDIAJB8GggAkHwaEobQZIPaiECCyADIAJB/wdqrUI0hr+iIQMLIAMLwAIDAX8BfgF/I4CAgIAAQRBrIgIkgICAgAACQAJAIAG9IgNCNIinQf8PcSIEQf8PRg0AIAQNAQJAAkAgAUQAAAAAAAAAAGENACACIAFEAAAAAAAA8EOiEI6AgIAAIAIgAigCCEFAajYCCAwBCyACQQA2AgggAiABOQMACyAAIAIpAwA3AwAgAEEIaiACQQhqKQMANwMAIAJBEGokgICAgAAPCyACIAE5AwACQCADQv///////////wCDQoCAgICAgID4/wBSDQAgAkEANgIICyAAIAIpAwA3AwAgAEEIaiACQQhqKQMANwMAIAJBEGokgICAgAAPCyAAIANC/////////4eAf4NCgICAgICAgPA/hCIDNwMAIAIgBEGCeGo2AgggAEEIaiACKQMINwMAIAIgAzcDACACQRBqJICAgIAACywBAX8CQCACRQ0AIAAhAwNAIAMgAToAACADQQFqIQMgAkF/aiICDQALCyAACzYBAX8CQCACRQ0AIAAhAwNAIAMgAS0AADoAACADQQFqIQMgAUEBaiEBIAJBf2oiAg0ACwsgAAsLNQIAQYAICyBABAAAEAAAAAAAAAAAAAAAAAAAAAAA4D8AAAAAAADgvwBBoAgLCAEAAAACAAAAAMgCBG5hbWUBwAIRACJzdGQuaGVhcC5XYXNtUGFnZUFsbG9jYXRvci5yZWFsbG9jAR5zdGQuaGVhcC5GcmVlQmxvY2sudXNlUmVjeWNsZWQCIXN0ZC5oZWFwLldhc21QYWdlQWxsb2NhdG9yLnNocmluawMIanNfYWxsb2MEB2pzX2ZyZWUFCmluaXRfc3ludGgGEHN0ZC5tYXRoLnNpbi5zaW4HEHN0ZC5tYXRoLnBvdy5wb3cICGdlbmVyYXRlCRdhZHNyLkFEU1IuZ2V0TXVsdGlwbGllcgoMcHJvY2Vzc19taWRpCxhzeW50aC5Wb2ljZVdyYXBwZXIuc2V0dXAMDnN0ZC5tYXRoLmxuLmxuDRBzdGQubWF0aC5leHAuZXhwDhZzdGQubWF0aC5mcmV4cC5mcmV4cDY0DwZtZW1zZXQQBm1lbWNweQAaCXByb2R1Y2VycwEIbGFuZ3VhZ2UBA0M5OQA=";
    </script>
    <script>function clear(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
}

function numMap(x, min, max, new_min, new_max) {
    return (x - min) * (new_max - new_min) / (max - min) + new_min;
}

function drawFrequencies(ctx, audio_ctx, data) {
    const dbToY = db => numMap(db, -120, 6, ctx.canvas.height, 0);
    const freqToX = freq => {
        if (freq === -1) {
            return 0;
        }

        return Math.log10(freq + 1) / Math.log10(audio_ctx.sampleRate / 2) * ctx.canvas.width
    };

    const db_lines = [0, -20, -40, -60, -80, -100, -120];
    db_lines.forEach(db => {
        const y = dbToY(db);

        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(ctx.canvas.width, y);
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'gray';
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle = 'orange';
        ctx.strokeText(`${db} dB`, 4, y - 4);
    });


    const calcX = x => Math.log10(x) / Math.log10(data.length) * ctx.canvas.width;
    const freq_lines = [1, 10, 100, 1000, 10000];

    freq_lines.forEach(freq => {
        const x = freqToX(freq);

        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'black';
        ctx.moveTo(x, 0);
        ctx.lineTo(x, ctx.canvas.height);
        ctx.stroke();

        for (let i = 1; i < 10; i++) {
            const thin_x = freqToX(freq + i * freq);

            ctx.beginPath();
            ctx.moveTo(thin_x, 0);
            ctx.lineTo(thin_x, ctx.canvas.height);
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'gray';
            ctx.stroke();
        }

        ctx.beginPath();
        ctx.strokeStyle = 'orange';
        ctx.strokeText(`${freq} Hz`, x + 4, dbToY(0) - 4);
    });

    ctx.beginPath();

    const minp = 0;
    const maxp = audio_ctx.sampleRate / 2;

    const minv = Math.log(0);
    const maxv = Math.log(audio_ctx.sampleRate / 2);
    const scale = (maxv - minv) / (maxp - minp);

    data.forEach((value, i) => {
        const frequency = i * (audio_ctx.sampleRate / 2) / data.length;
        const x = freqToX(frequency);
        const y = numMap(value, -140, 6, ctx.canvas.height, 0);

        if (i == 0) {
            ctx.moveTo(x, y);
            return;
        }

        ctx.lineTo(x, y);
    });

    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function drawOscilloscope(ctx, audio_ctx, data) {

    ctx.beginPath();
    ctx.moveTo(0, ctx.canvas.height / 2);
    ctx.lineTo(ctx.canvas.width, ctx.canvas.height / 2);
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.beginPath();
    data.forEach((value, i) => {
        const x = (data.length - i) / data.length * ctx.canvas.width;
        const y = ctx.canvas.height / 2 - value * (ctx.canvas.height / 2);

        if (i == 0) {
            ctx.moveTo(x, y);
            return;
        }

        ctx.lineTo(x, y);
    });

    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();
}

const wasm_binary_promise = fetch(window.wasmSource).then(res => res.arrayBuffer());
const play_button = document.getElementById('play-button');

let running = false;

play_button.addEventListener('click', e => start());

window.addEventListener('keydown', onKeyDown);

function onKeyDown(e) {
    window.removeEventListener('keydown', onKeyDown);

    if (e.code === 'Space') {
        start();
    }
}

function start() {
    if (running) {
        return;
    }

    running = true;

    const wrapper = play_button.parentElement;
    wrapper.parentElement.removeChild(wrapper);

    const canvas_spectrum = document.createElement('canvas');
    const canvas_oscilloscope = document.createElement('canvas');
    const ctx_spectrum = canvas_spectrum.getContext('2d');
    const ctx_oscilloscope = canvas_oscilloscope.getContext('2d');

    canvas_spectrum.height = canvas_oscilloscope.height = window.innerHeight / 2;
    canvas_spectrum.width = canvas_oscilloscope.width = window.innerWidth;

    document.body.appendChild(canvas_spectrum);
    document.body.appendChild(canvas_oscilloscope);

    const audio_ctx = new AudioContext();

    audio_ctx.audioWorklet.addModule(window.workletSource).then(() => {
        const analyser = audio_ctx.createAnalyser();

        analyser.fftSize = 512;
        let frequencies = new Float32Array(analyser.frequencyBinCount);
        let samples = new Float32Array(512);

        analyser.smoothingTimeConstant = 0.5;

        function render(t) {

            clear(ctx_spectrum);
            analyser.getFloatFrequencyData(frequencies);
            drawFrequencies(ctx_spectrum, audio_ctx, frequencies);

            clear(ctx_oscilloscope);
            analyser.getFloatTimeDomainData(samples);
            drawOscilloscope(ctx_oscilloscope, audio_ctx, samples);

            requestAnimationFrame(render);
        }

        requestAnimationFrame(render);

        const synth_node = new AudioWorkletNode(audio_ctx, 'zig-synth', {});
        synth_node.connect(analyser).connect(audio_ctx.destination);

        wasm_binary_promise .then(binary => {
            synth_node.port.postMessage({
                type: 'wasm-binary',
                data: binary,
                sample_rate: audio_ctx.sampleRate,
            });
        }).catch(console.error);

        navigator.requestMIDIAccess().then(access => {
            const inputs = access.inputs.values();

            for (const entry of inputs) {
                entry.addEventListener('midimessage', e => {
                    if (synth_node) {
                        synth_node.port.postMessage({
                            type: 'midi-message',
                            data: e.data,
                        });
                    }
                });
            }
        }).catch(console.error);
    });
}

</script>
</body>
</html>
