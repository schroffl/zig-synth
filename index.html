<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zig Synthesizer in WebAssembly</title>

    <style>
        body {
            font-family: Arial;
            margin: 0px;
            overflow: hidden;
        }

        #play-button {
            font-size: 42px;
            background-color: mediumpurple;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: #000 0px 5px 10px;
            margin-bottom: 20px;
            padding: 8px 16px;
        }

        #play-button:hover, #play-button:focus {
            outline: none;
            background-color: #5b32af;
        }

        #play-button:active {
            margin-top: 2px;
            margin-bottom: 18px;
            box-shadow: #000 0px 2px 6px;
        }

        .note {
            font-family: "Comic Sans MS";
            max-width: 50%;
            text-align: center;
        }

        .hash {
            position: absolute;
            cursor: help;
            top: 8px;
            left: 8px;
            color: rgba(0, 0, 0, 0.3);
        }

        .hash:hover {
            color: black;
        }

        @media (prefers-color-scheme: light) {
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #444;
                color: #eee;
            }

            .hash {
                color: rgba(238, 238, 238, 0.3);
            }

            .hash:hover {
                color: #eee;
            }
        }

        .button-wrapper {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="button-wrapper">
        <button id="play-button">Start</button>
        <div class="note">
            This button is required, because your browser prevents audio from playing automatically.
            Connect a MIDI input device and start playing.

            <hr>

            <small>
                Due to missing API implementations in most browsers, this is currently only known to work in Google Chrome.
                <br>
                Check <a href="https://caniuse.com/#search=Audio%20Worklet">Audio Worklet Support</a> to find out if this has changed.
            </small>
        </div>
        <div class="hash" title="This mainly exists to check weird browser cache behaviour">Build: 81915855608366d0</div>
    </div>

    <script>
        window.workletSource = "data:text/javascript;base64,ZnVuY3Rpb24gZ2V0U3RyaW5nKGluc3QsIHB0ciwgbGVuKSB7CiAgICBjb25zdCBzbGljZSA9IGRlcmVmQnVmZmVyKFVpbnQ4QXJyYXksIGluc3QsIHB0ciwgbGVuKTsKICAgIGNvbnN0IGFyciA9IFtdOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2xpY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaGFyID0gU3RyaW5nLmZyb21DaGFyQ29kZShzbGljZVtpXSk7CiAgICAgICAgYXJyLnB1c2goY2hhcik7CiAgICB9CgogICAgcmV0dXJuIGFyci5qb2luKCcnKTsKfQoKZnVuY3Rpb24gZGVyZWZCdWZmZXIoVCwgaW5zdCwgcHRyLCBsZW4pIHsKICAgIHJldHVybiBuZXcgVChpbnN0LmV4cG9ydHMubWVtb3J5LmJ1ZmZlciwgcHRyLCBsZW4pOwp9CgpmdW5jdGlvbiBhbGxvY0J1ZmZlcihULCBpbnN0LCBsZW4pIHsKICAgIGNvbnN0IHB0ciA9IGluc3QuZXhwb3J0cy5qc19hbGxvYyhULkJZVEVTX1BFUl9FTEVNRU5UICogbGVuKTsKCiAgICByZXR1cm4gewogICAgICAgIHB0cjogcHRyLAogICAgICAgIGRhdGE6IGRlcmVmQnVmZmVyKFQsIGluc3QsIHB0ciwgbGVuKSwKICAgIH07Cn0KCmZ1bmN0aW9uIGZyZWVCdWZmZXIoaW5zdCwgYnVmZmVyKSB7CiAgICBpbnN0LmV4cG9ydHMuanNfZnJlZShidWZmZXIucHRyLCBidWZmZXIuZGF0YS5ieXRlTGVuZ3RoKTsKfQoKY2xhc3MgWmlnU3ludGhQcm9jZXNzb3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHN1cGVyKCk7CgogICAgICAgIHRoaXMucG9ydC5vbm1lc3NhZ2UgPSB0aGlzLm9uTWVzc2FnZS5iaW5kKHRoaXMpOwogICAgfQoKICAgIGluaXRXYXNtKGJpbmFyeSwgc2FtcGxlX3JhdGUpIHsKICAgICAgICBsZXQgaW5zdGFuY2VfY2xvc3VyZSA9IHVuZGVmaW5lZDsKCiAgICAgICAgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUoYmluYXJ5LCB7CiAgICAgICAgICAgIGRlYnVnOiB7CiAgICAgICAgICAgICAgICBqc19lcnI6IChwdHIsIGxlbikgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9IGdldFN0cmluZyhpbnN0YW5jZV9jbG9zdXJlLCBwdHIsIGxlbik7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGpzX3dhcm46IChwdHIsIGxlbikgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9IGdldFN0cmluZyhpbnN0YW5jZV9jbG9zdXJlLCBwdHIsIGxlbik7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cobXNnKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSkudGhlbihpbnN0ID0+IHsKICAgICAgICAgICAgaW5zdGFuY2VfY2xvc3VyZSA9IGluc3QuaW5zdGFuY2U7CiAgICAgICAgICAgIGluc3QuaW5zdGFuY2UuZXhwb3J0cy5pbml0X3N5bnRoKHNhbXBsZV9yYXRlKTsKICAgICAgICAgICAgdGhpcy53YXNtID0gaW5zdC5pbnN0YW5jZTsKICAgICAgICB9KTsKICAgIH0KCiAgICBvbk1lc3NhZ2UoZXZlbnQpIHsKICAgICAgICBzd2l0Y2ggKGV2ZW50LmRhdGEudHlwZSkgewogICAgICAgICAgICBjYXNlICd3YXNtLWJpbmFyeSc6IHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFdhc20oZXZlbnQuZGF0YS5kYXRhLCBldmVudC5kYXRhLnNhbXBsZV9yYXRlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlICdtaWRpLW1lc3NhZ2UnOiB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NNSURJKGV2ZW50LmRhdGEuZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwcm9jZXNzTUlESShkYXRhKSB7CiAgICAgICAgY29uc3QgYnVmZmVyID0gYWxsb2NCdWZmZXIoVWludDhBcnJheSwgdGhpcy53YXNtLCBkYXRhLmJ5dGVMZW5ndGgpOwoKICAgICAgICBidWZmZXIuZGF0YS5zZXQoZGF0YSk7CiAgICAgICAgdGhpcy53YXNtLmV4cG9ydHMucHJvY2Vzc19taWRpKGJ1ZmZlci5wdHIsIGRhdGEuYnl0ZUxlbmd0aCk7CgogICAgICAgIGZyZWVCdWZmZXIodGhpcy53YXNtLCBidWZmZXIpOwogICAgfQoKICAgIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzLCBwYXJhbXMpIHsKICAgICAgICBpZiAoIXRoaXMud2FzbSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGNoYW5uZWwgPSBvdXRwdXRzWzBdWzBdOwogICAgICAgIGNvbnN0IGJ1ZmZlciA9IGFsbG9jQnVmZmVyKEZsb2F0MzJBcnJheSwgdGhpcy53YXNtLCBjaGFubmVsLmxlbmd0aCk7CgogICAgICAgIHRoaXMud2FzbS5leHBvcnRzLmdlbmVyYXRlKGJ1ZmZlci5wdHIsIGJ1ZmZlci5kYXRhLmxlbmd0aCk7CiAgICAgICAgY2hhbm5lbC5zZXQoYnVmZmVyLmRhdGEpOwoKICAgICAgICBmcmVlQnVmZmVyKHRoaXMud2FzbSwgYnVmZmVyKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cgp9CgpyZWdpc3RlclByb2Nlc3NvcignemlnLXN5bnRoJywgWmlnU3ludGhQcm9jZXNzb3IpOwo=";
        window.wasmSource = "data:application/octet-stream;base64,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";
    </script>
    <script>

function drawOscilloscope(ctx, audio_ctx, data) {}

function clear(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
}

function numMap(x, min, max, new_min, new_max) {
    return (x - min) * (new_max - new_min) / (max - min) + new_min;
}

function drawFrequencies(ctx, audio_ctx, data) {
    const dbToY = db => numMap(db, -120, 6, ctx.canvas.height, 0);
    const freqToX = freq => {
        if (freq === -1) {
            return 0;
        }

        return Math.log10(freq + 1) / Math.log10(audio_ctx.sampleRate / 2) * ctx.canvas.width
    };

    const db_lines = [0, -20, -40, -60, -80, -100, -120];
    db_lines.forEach(db => {
        const y = dbToY(db);

        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(ctx.canvas.width, y);
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'gray';
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle = 'orange';
        ctx.strokeText(`${db} dB`, 4, y - 4);
    });


    const calcX = x => Math.log10(x) / Math.log10(data.length) * ctx.canvas.width;
    const freq_lines = [1, 10, 100, 1000, 10000];

    freq_lines.forEach(freq => {
        const x = freqToX(freq);

        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'black';
        ctx.moveTo(x, 0);
        ctx.lineTo(x, ctx.canvas.height);
        ctx.stroke();

        for (let i = 1; i < 10; i++) {
            const thin_x = freqToX(freq + i * freq);

            ctx.beginPath();
            ctx.moveTo(thin_x, 0);
            ctx.lineTo(thin_x, ctx.canvas.height);
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'gray';
            ctx.stroke();
        }

        ctx.beginPath();
        ctx.strokeStyle = 'orange';
        ctx.strokeText(`${freq} Hz`, x + 4, dbToY(0) - 4);
    });

    ctx.beginPath();

    const minp = 0;
    const maxp = audio_ctx.sampleRate / 2;

    const minv = Math.log(0);
    const maxv = Math.log(audio_ctx.sampleRate / 2);
    const scale = (maxv - minv) / (maxp - minp);

    data.forEach((value, i) => {
        const frequency = i * (audio_ctx.sampleRate / 2) / data.length;
        const x = freqToX(frequency);
        const y = numMap(value, -140, 6, ctx.canvas.height, 0);

        if (i == 0) {
            ctx.moveTo(x, y);
            return;
        }

        ctx.lineTo(x, y);
    });

    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function drawOscilloscope(ctx, audio_ctx, data) {

    ctx.beginPath();
    ctx.moveTo(0, ctx.canvas.height / 2);
    ctx.lineTo(ctx.canvas.width, ctx.canvas.height / 2);
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.beginPath();
    data.forEach((value, i) => {
        const x = (data.length - i) / data.length * ctx.canvas.width;
        const y = ctx.canvas.height / 2 - value * (ctx.canvas.height / 2);

        if (i == 0) {
            ctx.moveTo(x, y);
            return;
        }

        ctx.lineTo(x, y);
    });

    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();
}

const wasm_binary_promise = fetch(window.wasmSource).then(res => res.arrayBuffer());
const play_button = document.getElementById('play-button');

let running = false;

play_button.addEventListener('click', e => start());

window.addEventListener('keydown', onKeyDown);

function onKeyDown(e) {
    window.removeEventListener('keydown', onKeyDown);

    if (e.code === 'Space') {
        start();
    }
}

function start() {
    if (running) {
        return;
    }

    running = true;

    const wrapper = play_button.parentElement;
    wrapper.parentElement.removeChild(wrapper);

    const canvas_spectrum = document.createElement('canvas');
    const canvas_oscilloscope = document.createElement('canvas');
    const ctx_spectrum = canvas_spectrum.getContext('2d');
    const ctx_oscilloscope = canvas_oscilloscope.getContext('2d');

    canvas_spectrum.height = canvas_oscilloscope.height = window.innerHeight / 2;
    canvas_spectrum.width = canvas_oscilloscope.width = window.innerWidth;

    document.body.appendChild(canvas_spectrum);
    document.body.appendChild(canvas_oscilloscope);

    const audio_ctx = new AudioContext();

    audio_ctx.audioWorklet.addModule(window.workletSource).then(() => {
        const analyser = audio_ctx.createAnalyser();

        analyser.fftSize = 512;
        let frequencies = new Float32Array(analyser.frequencyBinCount);
        let samples = new Float32Array(512);

        analyser.smoothingTimeConstant = 0.5;

        function render(t) {

            clear(ctx_spectrum);
            analyser.getFloatFrequencyData(frequencies);
            drawFrequencies(ctx_spectrum, audio_ctx, frequencies);

            clear(ctx_oscilloscope);
            analyser.getFloatTimeDomainData(samples);
            drawOscilloscope(ctx_oscilloscope, audio_ctx, samples);

            requestAnimationFrame(render);
        }

        requestAnimationFrame(render);

        const synth_node = new AudioWorkletNode(audio_ctx, 'zig-synth', {});
        synth_node.connect(analyser).connect(audio_ctx.destination);

        wasm_binary_promise .then(binary => {
            synth_node.port.postMessage({
                type: 'wasm-binary',
                data: binary,
                sample_rate: audio_ctx.sampleRate,
            });
        }).catch(console.error);

        navigator.requestMIDIAccess().then(access => {
            const inputs = access.inputs.values();

            for (const entry of inputs) {
                entry.addEventListener('midimessage', e => {
                    if (synth_node) {
                        synth_node.port.postMessage({
                            type: 'midi-message',
                            data: e.data,
                        });
                    }
                });
            }
        }).catch(console.error);
    });
}

</script>
</body>
</html>
